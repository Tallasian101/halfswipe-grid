<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clicker Market with Prestige System & Click Upgrade</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
    #game { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    button { padding: 10px 15px; font-size: 16px; cursor: pointer; margin: 5px 0; }
    .item { border: 1px solid #ddd; padding: 8px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; display: inline-block; }
    .common { color: #555; }
    .uncommon { color: green; }
    .rare { color: purple; }
    .legendary { color: orange; font-weight: bold; }
    .mythic { color: crimson; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px;}
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left;}
    #stats {
      background: #eee;
      padding: 10px;
      margin-top: 20px;
      border-radius: 8px;
    }
    #filters {
      margin-top: 15px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    label {
      font-weight: bold;
    }
    #tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 8px;
      border-radius: 6px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      max-width: 200px;
      z-index: 1000;
      font-size: 14px;
    }
    #prestigeSection {
      margin-top: 20px;
      padding: 15px;
      background: #dfefff;
      border-radius: 8px;
      text-align: center;
    }
    #prestigeBtn {
      padding: 10px 20px;
      font-size: 18px;
      font-weight: bold;
      background-color: #0044cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #prestigeBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="game">
    <h1>Clicker Market with Prestige System</h1>
    <p>Money: $<span id="money">0</span></p>

    <!-- CLICK VALUE & UPGRADE -->
    <div>
      <p>Click Value: <span id="clickValueDisplay">$1</span></p>
      <button id="upgradeClickBtn">Upgrade Click ($<span id="clickUpgradeCost">50</span>)</button>
    </div>

    <button id="earnMoneyBtn">Click to earn money</button>

    <h2>Buy Chests</h2>
    <div id="chestStore"></div>

    <h2>Your Inventory</h2>

    <div id="filters">
      <label>Filter by Rarity:
        <select id="inventoryRarityFilter">
          <option value="all">All</option>
          <option value="common">Common</option>
          <option value="uncommon">Uncommon</option>
          <option value="rare">Rare</option>
          <option value="legendary">Legendary</option>
          <option value="mythic">Mythic</option>
        </select>
      </label>

      <label>Sort by Price:
        <select id="inventoryPriceSort">
          <option value="none">None</option>
          <option value="asc">Low to High</option>
          <option value="desc">High to Low</option>
        </select>
      </label>
    </div>

    <div id="inventory"></div>

    <h2>Market</h2>

    <div id="filters">
      <label>Filter by Rarity:
        <select id="marketRarityFilter">
          <option value="all">All</option>
          <option value="common">Common</option>
          <option value="uncommon">Uncommon</option>
          <option value="rare">Rare</option>
          <option value="legendary">Legendary</option>
          <option value="mythic">Mythic</option>
        </select>
      </label>

      <label>Sort by Price:
        <select id="marketPriceSort">
          <option value="none">None</option>
          <option value="asc">Low to High</option>
          <option value="desc">High to Low</option>
        </select>
      </label>
    </div>

    <table>
      <thead>
        <tr><th>Item</th><th>Rarity</th><th>Price</th><th>Sell</th></tr>
      </thead>
      <tbody id="market"></tbody>
    </table>

    <div id="stats">
      <h3>Stats</h3>
      <p>Highest Money Ever Earned: $<span id="highestMoney">0</span></p>
      <p>Rarest Item Collected: <span id="rarestItem">None</span></p>
      <p>Prestige Level: <span id="prestigeLevel">0</span></p>
      <button id="shareBtn">Share on Twitter</button>
    </div>

    <div id="prestigeSection">
      <p>Prestige Cost: $<span id="prestigeCost">1000</span></p>
      <button id="prestigeBtn" disabled>Prestige</button>
      <p><small>Prestiging resets your money & inventory but increases your chance for rarer items in chests!</small></p>
    </div>
  </div>

  <div id="tooltip"></div>

<script>
  const itemsData = [
    // Common
    {name: 'Wooden Stick', rarity: 'common', basePrice: 5, description: 'A simple wooden stick.'},
    {name: 'Wooden Shield', rarity: 'common', basePrice: 8, description: 'Basic shield made of wood.'},
    {name: 'Leather Boots', rarity: 'common', basePrice: 7, description: 'Sturdy leather boots.'},

    // Uncommon
    {name: 'Iron Sword', rarity: 'uncommon', basePrice: 20, description: 'A sharp iron sword.'},
    {name: 'Steel Helmet', rarity: 'uncommon', basePrice: 25, description: 'Helmet made of steel.'},
    {name: 'Crossbow', rarity: 'uncommon', basePrice: 30, description: 'A ranged weapon with bolts.'},

    // Rare
    {name: 'Magic Wand', rarity: 'rare', basePrice: 100, description: 'A wand imbued with magic.'},
    {name: 'Phoenix Feather', rarity: 'rare', basePrice: 120, description: 'A rare feather from a phoenix.'},
    {name: 'Enchanted Cloak', rarity: 'rare', basePrice: 150, description: 'Cloak with magical properties.'},

    // Legendary
    {name: 'Dragon Egg', rarity: 'legendary', basePrice: 500, description: 'A rare dragon egg.'},
    {name: 'Sword of Light', rarity: 'legendary', basePrice: 550, description: 'A legendary sword that shines.'},
    {name: 'Ancient Tome', rarity: 'legendary', basePrice: 600, description: 'Book of ancient knowledge.'},

    // Mythic
    {name: 'Mythic Orb', rarity: 'mythic', basePrice: 1500, description: 'An orb of mythical power.'},
    {name: 'Crown of Kings', rarity: 'mythic', basePrice: 1800, description: 'The crown worn by kings.'},
    {name: 'Staff of Eternity', rarity: 'mythic', basePrice: 2000, description: 'A staff that controls time.'},
  ];

  const rarityClass = {
    'common': 'common',
    'uncommon': 'uncommon',
    'rare': 'rare',
    'legendary': 'legendary',
    'mythic': 'mythic'
  };

  const rarityOrder = {common:1, uncommon:2, rare:3, legendary:4, mythic:5};

  // Base chest rarities, before prestige bonuses
  const baseChests = [
    {
      name: 'Wooden Chest',
      cost: 10,
      rarityChances: {common: 0.8, uncommon: 0.15, rare: 0.04, legendary: 0.01, mythic: 0}
    },
    {
      name: 'Silver Chest',
      cost: 50,
      rarityChances: {common: 0.5, uncommon: 0.35, rare: 0.12, legendary: 0.03, mythic: 0}
    },
    {
      name: 'Golden Chest',
      cost: 200,
      rarityChances: {common: 0.2, uncommon: 0.4, rare: 0.3, legendary: 0.1, mythic: 0}
    },
    {
      name: 'Platinum Chest',
      cost: 500,
      rarityChances: {common: 0.1, uncommon: 0.3, rare: 0.35, legendary: 0.2, mythic: 0.05}
    },
    {
      name: 'Diamond Chest',
      cost: 1500,
      rarityChances: {common: 0.05, uncommon: 0.2, rare: 0.3, legendary: 0.3, mythic: 0.15}
    }
  ];

  let chests = JSON.parse(JSON.stringify(baseChests)); // Will update rarity chances on prestige

  let money = 0;
  let highestMoney = 0;
  let inventory = {};
  let marketSupply = {};
  itemsData.forEach(item => marketSupply[item.name] = 0);

  let currentMarketEvent = null;

  let prestigeLevel = 0;
  const prestigeCostBase = 1000;

  // --- NEW: Click Upgrade Variables ---
  let clickValue = 1;
  let clickUpgradeCost = 50;

  const moneyDisplay = document.getElementById('money');
  const highestMoneyDisplay = document.getElementById('highestMoney');
  const rarestItemDisplay = document.getElementById('rarestItem');
  const inventoryDiv = document.getElementById('inventory');
  const marketTbody = document.getElementById('market');
  const tooltip = document.getElementById('tooltip');
  const prestigeBtn = document.getElementById('prestigeBtn');
  const prestigeCostDisplay = document.getElementById('prestigeCost');
  const prestigeLevelDisplay = document.getElementById('prestigeLevel');

  // New UI elements for click upgrade
  const clickValueDisplay = document.getElementById('clickValueDisplay');
  const clickUpgradeCostDisplay = document.getElementById('clickUpgradeCost');
  const upgradeClickBtn = document.getElementById('upgradeClickBtn');

  // Update money and highest money
  function updateMoney() {
    moneyDisplay.textContent = money;
    if (money > highestMoney) {
      highestMoney = money;
      highestMoneyDisplay.textContent = highestMoney;
    }
    updatePrestigeButton();
  }

  // Update prestige button enabled/disabled state
  function updatePrestigeButton() {
    prestigeBtn.disabled = money < getPrestigeCost();
  }

  // Calculate prestige cost increasing per level
  function getPrestigeCost() {
    return prestigeCostBase * Math.pow(2, prestigeLevel);
  }

  // Apply prestige bonuses to chest rarity chances
  function applyPrestigeToChests() {
    // For each chest, increase rare+ chances slightly per prestige level
    chests = JSON.parse(JSON.stringify(baseChests)); // reset

    chests.forEach(chest => {
      let common = chest.rarityChances.common;
      let uncommon = chest.rarityChances.uncommon;
      let rare = chest.rarityChances.rare;
      let legendary = chest.rarityChances.legendary;
      let mythic = chest.rarityChances.mythic || 0;

      // Each prestige level adds +2% rare, +1.5% legendary, +1% mythic
      const rareBoost = 0.02 * prestigeLevel;
      const legendaryBoost = 0.015 * prestigeLevel;
      const mythicBoost = 0.01 * prestigeLevel;

      rare += rareBoost;
      legendary += legendaryBoost;
      mythic += mythicBoost;

      // Subtract boosts proportionally from common and uncommon to keep total 1
      let totalBoost = rareBoost + legendaryBoost + mythicBoost;
      const reduceFromCommon = totalBoost * 0.7;
      const reduceFromUncommon = totalBoost * 0.3;

      common = Math.max(0, common - reduceFromCommon);
      uncommon = Math.max(0, uncommon - reduceFromUncommon);

      // Normalize in case of floating point errors
      let total = common + uncommon + rare + legendary + mythic;
      common /= total;
      uncommon /= total;
      rare /= total;
      legendary /= total;
      mythic /= total;

      chest.rarityChances = {common, uncommon, rare, legendary, mythic};
    });
  }

  function addToInventory(item) {
    if (!inventory[item.name]) inventory[item.name] = 0;
    inventory[item.name]++;
    updateInventory();
    updateMarket();
    updateRarestItem();
  }

  function removeFromInventory(itemName) {
    if (inventory[itemName] && inventory[itemName] > 0) {
      inventory[itemName]--;
      if (inventory[itemName] === 0) delete inventory[itemName];
      updateInventory();
      updateMarket();
      return true;
    }
    return false;
  }

  function getMarketPrice(itemName) {
    const item = itemsData.find(i => i.name === itemName);
    const supply = marketSupply[itemName] || 0;
    let price = item.basePrice * (1 / (1 + supply * 0.3));

    if (currentMarketEvent) {
      if (currentMarketEvent.type === 'legendary_surge' && (item.rarity === 'legendary' || item.rarity === 'mythic')) {
        price *= 1.5;
      } else if (currentMarketEvent.type === 'market_crash') {
        price *= 0.7;
      } else if (currentMarketEvent.type === 'uncommon_boom' && item.rarity === 'uncommon') {
        price *= 1.4;
      }
    }

    return Math.max(1, Math.round(price));
  }

  function updateRarestItem() {
    let rarestRank = 0;
    let rarestName = 'None';
    for (const itemName in inventory) {
      const item = itemsData.find(i => i.name === itemName);
      if (rarityOrder[item.rarity] > rarestRank && inventory[itemName] > 0) {
        rarestRank = rarityOrder[item.rarity];
        rarestName = itemName + ` (${item.rarity})`;
      }
    }
    rarestItemDisplay.textContent = rarestName;
  }

  function updateInventory() {
    inventoryDiv.innerHTML = '';

    const filter = document.getElementById('inventoryRarityFilter').value;
    const sort = document.getElementById('inventoryPriceSort').value;

    let invItems = Object.entries(inventory).map(([name, count]) => {
      const item = itemsData.find(i => i.name === name);
      return { ...item, count, price: getMarketPrice(name) };
    });

    if (filter !== 'all') {
      invItems = invItems.filter(i => i.rarity === filter);
    }

    if (sort === 'asc') {
      invItems.sort((a, b) => a.price - b.price);
    } else if (sort === 'desc') {
      invItems.sort((a, b) => b.price - a.price);
    }

    if (invItems.length === 0) {
      inventoryDiv.innerHTML = '<p>No items match the filter.</p>';
      return;
    }

    invItems.forEach(item => {
      const div = document.createElement('div');
      div.className = `item ${rarityClass[item.rarity]}`;
      div.textContent = `${item.name} x${item.count} - $${item.price}`;
      div.dataset.description = item.description;

      div.addEventListener('mousemove', (e) => {
        showTooltip(e.pageX, e.pageY, item.description);
      });
      div.addEventListener('mouseleave', hideTooltip);

      inventoryDiv.appendChild(div);
    });
  }

  function updateMarket() {
    marketTbody.innerHTML = '';

    const filter = document.getElementById('marketRarityFilter').value;
    const sort = document.getElementById('marketPriceSort').value;

    let marketItems = itemsData.map(item => {
      return {
        ...item,
        price: getMarketPrice(item.name),
        supply: marketSupply[item.name] || 0,
        count: inventory[item.name] || 0
      };
    });

    if (filter !== 'all') {
      marketItems = marketItems.filter(i => i.rarity === filter);
    }

    if (sort === 'asc') {
      marketItems.sort((a, b) => a.price - b.price);
    } else if (sort === 'desc') {
      marketItems.sort((a, b) => b.price - a.price);
    }

    marketItems.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="${rarityClass[item.rarity]}" title="${item.description}">${item.name}</td>
        <td class="${rarityClass[item.rarity]}">${item.rarity}</td>
        <td>$${item.price}</td>
        <td><button ${item.count === 0 ? 'disabled' : ''} data-item="${item.name}">Sell</button></td>
      `;
      marketTbody.appendChild(tr);

      tr.querySelector('button').addEventListener('click', () => {
        if (removeFromInventory(item.name)) {
          money += item.price;
          marketSupply[item.name] = (marketSupply[item.name] || 0) + 1;
          updateMoney();
          updateInventory();
          updateMarket();
          saveGame();
        }
      });
    });
  }

  function showTooltip(x, y, text) {
    tooltip.style.left = (x + 15) + 'px';
    tooltip.style.top = (y + 15) + 'px';
    tooltip.textContent = text;
    tooltip.style.opacity = 1;
  }
  function hideTooltip() {
    tooltip.style.opacity = 0;
  }

  function openChest(chest) {
    if (money < chest.cost) {
      alert('Not enough money to open this chest!');
      return;
    }
    money -= chest.cost;
    updateMoney();

    // Determine rarity based on chest chances with prestige bonus applied
    const chances = chest.rarityChances;
    const rand = Math.random();
    let cumulative = 0;
    let rarity = 'common';

    for (const r of ['common', 'uncommon', 'rare', 'legendary', 'mythic']) {
      cumulative += chances[r] || 0;
      if (rand <= cumulative) {
        rarity = r;
        break;
      }
    }

    // Get all items of that rarity
    const candidates = itemsData.filter(i => i.rarity === rarity);
    if (candidates.length === 0) {
      alert('No items available for this rarity.');
      return;
    }
    const item = candidates[Math.floor(Math.random() * candidates.length)];

    addToInventory(item);
    alert(`You got: ${item.name} (${item.rarity})!`);

    saveGame();
  }

  function createChestButtons() {
    const chestStore = document.getElementById('chestStore');
    chestStore.innerHTML = '';
    chests.forEach(chest => {
      const btn = document.createElement('button');
      btn.textContent = `${chest.name} - $${chest.cost}`;
      btn.addEventListener('click', () => openChest(chest));
      chestStore.appendChild(btn);
    });
  }

  // SHARE TO TWITTER
  document.getElementById('shareBtn').addEventListener('click', () => {
    const text = encodeURIComponent(
      `I have $${money} and reached Prestige Level ${prestigeLevel} in the Clicker Market Game! #ClickerMarket`
    );
    const url = 'https://twitter.com/intent/tweet?text=' + text;
    window.open(url, '_blank');
  });

  // FILTER & SORT EVENTS
  document.getElementById('inventoryRarityFilter').addEventListener('change', updateInventory);
  document.getElementById('inventoryPriceSort').addEventListener('change', updateInventory);
  document.getElementById('marketRarityFilter').addEventListener('change', updateMarket);
  document.getElementById('marketPriceSort').addEventListener('change', updateMarket);

  // --- CLICK EARNING ---
  document.getElementById('earnMoneyBtn').addEventListener('click', () => {
    money += clickValue;
    updateMoney();
  });

  // --- CLICK UPGRADE BUTTON ---
  upgradeClickBtn.addEventListener('click', () => {
    if (money >= clickUpgradeCost) {
      money -= clickUpgradeCost;
      clickValue++;
      clickUpgradeCost = Math.floor(clickUpgradeCost * 1.5);
      updateMoney();
      updateClickUI();
      saveGame();
    } else {
      alert('Not enough money to upgrade click!');
    }
  });

  function updateClickUI() {
    clickValueDisplay.textContent = `$${clickValue}`;
    clickUpgradeCostDisplay.textContent = clickUpgradeCost;
  }

  // --- PRESTIGE ---
  prestigeBtn.addEventListener('click', () => {
    if (money >= getPrestigeCost()) {
      if (!confirm('Are you sure you want to prestige? This will reset your money and inventory but increase rarity chances!')) {
        return;
      }
      money = 0;
      inventory = {};
      marketSupply = {};
      itemsData.forEach(item => marketSupply[item.name] = 0);
      prestigeLevel++;
      // Reset click upgrades on prestige for balance (optional, comment out if you want to keep)
      clickValue = 1;
      clickUpgradeCost = 50;
      applyPrestigeToChests();
      updateClickUI();
      updateMoney();
      updateInventory();
      updateMarket();
      saveGame();
      prestigeLevelDisplay.textContent = prestigeLevel;
      prestigeCostDisplay.textContent = getPrestigeCost();
      alert('You prestiged! Your chance to get rare items increased.');
    }
  });

  // --- SAVE & LOAD ---
  function saveGame() {
    localStorage.setItem('money', money);
    localStorage.setItem('highestMoney', highestMoney);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    localStorage.setItem('marketSupply', JSON.stringify(marketSupply));
    localStorage.setItem('prestigeLevel', prestigeLevel);
    localStorage.setItem('clickValue', clickValue);
    localStorage.setItem('clickUpgradeCost', clickUpgradeCost);
  }

  function loadGame() {
    money = parseInt(localStorage.getItem('money')) || 0;
    highestMoney = parseInt(localStorage.getItem('highestMoney')) || 0;
    inventory = JSON.parse(localStorage.getItem('inventory')) || {};
    marketSupply = JSON.parse(localStorage.getItem('marketSupply')) || {};
    itemsData.forEach(item => {
      if (!marketSupply[item.name]) marketSupply[item.name] = 0;
    });
    prestigeLevel = parseInt(localStorage.getItem('prestigeLevel')) || 0;
    clickValue = parseInt(localStorage.getItem('clickValue')) || 1;
    clickUpgradeCost = parseInt(localStorage.getItem('clickUpgradeCost')) || 50;

    applyPrestigeToChests();
    updateMoney();
    updateInventory();
    updateMarket();
    updateClickUI();
    prestigeLevelDisplay.textContent = prestigeLevel;
    prestigeCostDisplay.textContent = getPrestigeCost();
  }

  // Initialize
  createChestButtons();
  loadGame();

  // Save every 10 seconds
  setInterval(saveGame, 10000);

</script>

</body>
</html>
